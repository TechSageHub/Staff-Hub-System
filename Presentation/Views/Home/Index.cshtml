@using Application.Dtos
@{
    ViewData["Title"] = "Dashboard";
    var recentEmployees = ViewBag.RecentEmployees as List<EmployeeDto> ?? new List<EmployeeDto>();
}

<style>
    .dashboard-hero {
        background: linear-gradient(135deg, #0b5ed7 0%, #0dcaf0 55%, #20c997 100%);
        color: #fff;
    }
    .dashboard-hero .muted {
        color: rgba(255, 255, 255, 0.75);
    }
    .kpi-card {
        border: 1px solid rgba(13, 110, 253, 0.08);
    }
    .kpi-icon {
        width: 44px;
        height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 14px;
    }
    .section-title {
        letter-spacing: 0.04em;
    }
    .panel {
        border: 1px solid rgba(0, 0, 0, 0.06);
    }
    .action-tile {
        border: 1px solid rgba(13, 110, 253, 0.12);
    }
</style>

<div class="container-fluid px-0">
    <div class="dashboard-hero rounded-4 shadow-sm p-4 p-md-5 mb-4">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
            <div>
                <h1 class="display-6 fw-bold mb-2">StaffHubSystem Dashboard</h1>
                <p class="muted mb-0">Clear visibility across people, time, and communications.</p>
            </div>
            <div class="d-flex gap-2">
                <span class="badge bg-light text-dark px-3 py-2 rounded-pill"><i class="bi bi-shield-check me-1"></i>Secure</span>
                <span class="badge bg-light text-dark px-3 py-2 rounded-pill"><i class="bi bi-lightning-charge me-1"></i>Fast Access</span>
            </div>
        </div>
    </div>

    @if (User.Identity!.IsAuthenticated)
    {
        @if (User.IsInRole("Admin"))
        {
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                    <div class="text-muted small text-uppercase fw-bold section-title">Admin</div>
                    <h3 class="fw-bold mb-0">Command Center</h3>
                </div>
                <a asp-controller="Announcement" asp-action="Create" class="btn btn-primary rounded-pill px-4">Post Announcement</a>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card kpi-card shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="kpi-icon bg-primary bg-opacity-10 text-primary">
                                    <i class="bi bi-people fs-4"></i>
                                </div>
                                <div>
                                    <div class="text-muted small text-uppercase fw-bold">Total Employees</div>
                                    <div class="fs-2 fw-bold">@ViewBag.TotalEmployees</div>
                                </div>
                            </div>
                            <div class="text-muted small mt-3">Active workforce overview.</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card kpi-card shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="kpi-icon bg-info bg-opacity-10 text-info">
                                    <i class="bi bi-building fs-4"></i>
                                </div>
                                <div>
                                    <div class="text-muted small text-uppercase fw-bold">Departments</div>
                                    <div class="fs-2 fw-bold">@ViewBag.TotalDepartments</div>
                                </div>
                            </div>
                            <div class="text-muted small mt-3">Organizational structure.</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card kpi-card shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="kpi-icon bg-success bg-opacity-10 text-success">
                                    <i class="bi bi-activity fs-4"></i>
                                </div>
                                <div>
                                    <div class="text-muted small text-uppercase fw-bold">System Status</div>
                                    <div class="fs-5 fw-bold text-success">Operational</div>
                                </div>
                            </div>
                            <div class="text-muted small mt-3">All services responsive.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-8">
                    <div class="card panel shadow-sm rounded-4 h-100">
                        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0">Recent Hires</h5>
                            <a asp-controller="Employee" asp-action="Index" class="btn btn-sm btn-outline-primary rounded-pill px-3">View All</a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4">Name</th>
                                            <th>Department</th>
                                            <th class="text-end pe-4">Hire Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (!recentEmployees.Any())
                                        {
                                            <tr>
                                                <td colspan="3" class="text-center py-4 text-muted">No recent hires found.</td>
                                            </tr>
                                        }
                                        else
                                        {
                                            @foreach (var emp in recentEmployees)
                                            {
                                                <tr>
                                                    <td class="ps-4">
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center fw-bold me-2" style="width: 32px; height: 32px; font-size: 12px;">
                                                                @emp.FirstName[0]@emp.LastName[0]
                                                            </div>
                                                            <span class="fw-medium">@emp.FirstName @emp.LastName</span>
                                                        </div>
                                                    </td>
                                                    <td><span class="badge bg-light text-dark border fw-normal">@emp.DepartmentName</span></td>
                                                    <td class="text-end pe-4 text-muted small">@emp.HireDate.ToString("MMM dd, yyyy")</td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card panel shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-3">Operations</h5>
                            <div class="d-grid gap-3">
                                <a asp-controller="Employee" asp-action="Create" class="btn btn-light text-start py-3 rounded-3 action-tile">
                                    <i class="bi bi-person-plus me-2 text-primary"></i> Add New Employee
                                </a>
                                <a asp-controller="Department" asp-action="Create" class="btn btn-light text-start py-3 rounded-3 action-tile">
                                    <i class="bi bi-building-add me-2 text-primary"></i> Create Department
                                </a>
                                <a asp-controller="Employee" asp-action="BulkUpload" class="btn btn-light text-start py-3 rounded-3 action-tile">
                                    <i class="bi bi-cloud-upload me-2 text-primary"></i> Bulk Upload Staff
                                </a>
                                <a asp-controller="Leave" asp-action="AdminDashboard" class="btn btn-light text-start py-3 rounded-3 action-tile">
                                    <i class="bi bi-clipboard-data me-2 text-primary"></i> Leave Requests
                                </a>
                                <a asp-controller="Announcement" asp-action="Index" class="btn btn-light text-start py-3 rounded-3 action-tile">
                                    <i class="bi bi-megaphone me-2 text-primary"></i> Announcements
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card panel shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0"><i class="bi bi-megaphone me-2"></i>Company Announcements</h5>
                    <a asp-controller="Announcement" asp-action="Index" class="btn btn-sm btn-outline-primary rounded-pill px-3">Manage All</a>
                </div>
                <div class="card-body p-4">
                    @{
                        var announcements = ViewBag.Announcements as List<Application.Dtos.AnnouncementDto> ?? new List<Application.Dtos.AnnouncementDto>();
                    }
                    @if (!announcements.Any())
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-megaphone fs-1 opacity-25 d-block mb-2"></i>
                            No announcements yet.
                        </div>
                    }
                    else
                    {
                        @foreach (var announcement in announcements)
                        {
                            <div class="alert alert-@(announcement.IsPinned ? "primary" : "light") border-0 shadow-sm mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-1">
                                            @if (announcement.IsPinned)
                                            {
                                                <i class="bi bi-pin-angle-fill me-1"></i>
                                            }
                                            @announcement.Title
                                        </h6>
                                        <p class="mb-2">@announcement.Content</p>
                                        <small class="text-muted">
                                            <i class="bi bi-person-circle me-1"></i>@announcement.AuthorName •
                                            <i class="bi bi-calendar3 me-1"></i>@announcement.DatePosted.ToString("MMM dd, yyyy")
                                        </small>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        }
        else
        {
            var myEmployee = ViewBag.MyEmployee as EmployeeDto;
            var leaveBalance = ViewBag.LeaveBalance as int? ?? 0;
            var todayAttendance = ViewBag.TodayAttendance as AttendanceLogDto;

            <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                    <div class="text-muted small text-uppercase fw-bold section-title">Employee</div>
                    <h3 class="fw-bold mb-0">My Workspace</h3>
                </div>
                <a asp-controller="Leave" asp-action="Create" class="btn btn-primary rounded-pill px-4">Request Leave</a>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card kpi-card shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="kpi-icon bg-primary bg-opacity-10 text-primary">
                                    <i class="bi bi-person-badge fs-4"></i>
                                </div>
                                <div>
                                    <div class="text-muted small text-uppercase fw-bold">Profile</div>
                                    <div class="fw-bold">@((myEmployee == null) ? "Complete Profile" : $"{myEmployee.FirstName} {myEmployee.LastName}")</div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <a asp-controller="Employee" asp-action="MyProfile" class="btn btn-sm btn-outline-primary rounded-pill me-2">View</a>
                                <a asp-controller="Account" asp-action="EditProfile" class="btn btn-sm btn-primary rounded-pill">Edit</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card kpi-card shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="kpi-icon bg-info bg-opacity-10 text-info">
                                    <i class="bi bi-calendar-check fs-4"></i>
                                </div>
                                <div>
                                    <div class="text-muted small text-uppercase fw-bold">Leave Balance</div>
                                    <div class="fs-2 fw-bold">@leaveBalance</div>
                                </div>
                            </div>
                            <div class="text-muted small mt-3">Days remaining this year.</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card kpi-card shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-3">
                                <div class="kpi-icon bg-success bg-opacity-10 text-success">
                                    <i class="bi bi-clock-history fs-4"></i>
                                </div>
                                <div>
                                    <div class="text-muted small text-uppercase fw-bold">Today's Attendance</div>
                                    <div class="fw-bold">
                                        @if (todayAttendance?.ClockOutTime != null)
                                        {
                                            <span>Clocked Out</span>
                                        }
                                        else if (todayAttendance != null)
                                        {
                                            <span>Clocked In</span>
                                        }
                                        else
                                        {
                                            <span>Not Clocked In</span>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="text-muted small mt-3">Track your daily record.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="card panel shadow-sm rounded-4 h-100">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-3">My Actions</h5>
                            <div class="d-grid gap-3">
                                <a asp-controller="Attendance" asp-action="Index" class="btn btn-light text-start py-3 rounded-3 action-tile">
                                    <i class="bi bi-clock me-2 text-primary"></i> Attendance
                                </a>
                                <a asp-controller="Leave" asp-action="Index" class="btn btn-light text-start py-3 rounded-3 action-tile">
                                    <i class="bi bi-calendar2-week me-2 text-primary"></i> Leave Portal
                                </a>
                                <a asp-controller="Announcement" asp-action="Index" class="btn btn-light text-start py-3 rounded-3 action-tile">
                                    <i class="bi bi-megaphone me-2 text-primary"></i> Announcements
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card panel shadow-sm rounded-4 h-100">
                        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0"><i class="bi bi-megaphone me-2"></i>Company Announcements</h5>
                            <a asp-controller="Announcement" asp-action="Index" class="btn btn-sm btn-outline-primary rounded-pill px-3">View All</a>
                        </div>
                        <div class="card-body p-4">
                            @{
                                var announcements = ViewBag.Announcements as List<Application.Dtos.AnnouncementDto> ?? new List<Application.Dtos.AnnouncementDto>();
                            }
                            @if (!announcements.Any())
                            {
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-megaphone fs-1 opacity-25 d-block mb-2"></i>
                                    No announcements yet.
                                </div>
                            }
                            else
                            {
                                @foreach (var announcement in announcements)
                                {
                                    <div class="alert alert-@(announcement.IsPinned ? "primary" : "light") border-0 shadow-sm mb-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="fw-bold mb-1">
                                                    @if (announcement.IsPinned)
                                                    {
                                                        <i class="bi bi-pin-angle-fill me-1"></i>
                                                    }
                                                    @announcement.Title
                                                </h6>
                                                <p class="mb-2">@announcement.Content</p>
                                                <small class="text-muted">
                                                    <i class="bi bi-person-circle me-1"></i>@announcement.AuthorName •
                                                    <i class="bi bi-calendar3 me-1"></i>@announcement.DatePosted.ToString("MMM dd, yyyy")
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="text-center py-5">
            <h2 class="fw-bold">Ready to manage your team?</h2>
            <p class="text-muted mb-4 fs-5">Sign in to access your administrative tools and organization insights.</p>
            <a asp-controller="Account" asp-action="Login" class="btn btn-primary btn-lg rounded-pill px-5 shadow">Get Started</a>
        </div>
    }
</div>
